#!/usr/bin/env node
'use strict'

const log = require('fancy-log')

const GitHub = require('../lib/github')
const Slack = require('../lib/slack')

// ----------------------------------------------------------------------------

const team = process.env.SLACK_TEAM
const email = process.env.SLACK_EMAIL
const password = process.env.SLACK_PASSWORD
const serviceId = process.env.SLACK_SERVICE_ID
const token = process.env.GITHUB_API_TOKEN
const username = process.env.GITHUB_USER_NAME

// ----------------------------------------------------------------------------

if (!team) {
  log.error('`SLACK_TEAM` not found')
  process.exit(1)
}

if (!email) {
  log.error('`SLACK_EMAIL` not found')
  process.exit(1)
}

if (!password) {
  log.error('`SLACK_PASSWORD` not found')
  process.exit(1)
}

if (!serviceId) {
  log.error('`SLACK_SERVICE_ID` not found')
  process.exit(1)
}

if (!token) {
  log.error('`GITHUB_API_TOKEN` not found')
  process.exit(1)
}

if (!username) {
  log.error('`GITHUB_USER_NAME` not found')
  process.exit(1)
}

// ----------------------------------------------------------------------------


!async function () {
  try {
    const github = new GitHub({ token })
    const slack = new Slack({ team, email, password })

    const repos = await github.repos(username)
    log(`${repos.length} repositories found in GitHub`)

    await slack.updateService(serviceId, repos)
  } catch (err) {
    log.error(err)
    process.exit(1)
  }
}()

// vim: se et ts=2 sw=2 sts=2 ft=javascript :
