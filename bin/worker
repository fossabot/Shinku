#!/usr/bin/env node
'use strict'

const { execFile } = require('child_process')
const { join } = require('path')

const log = require('fancy-log')
const { CronJob } = require('cron')

const job = new CronJob({
  cronTime: '00 */12 * * *',
  onTick() {
    log('Cron job started')

    const ps = execFile(process.execPath, [ join(__dirname, 'job') ])
    ps.stdout.on('data', data => process.stdout.write(data))
    ps.stderr.on('data', data => process.stderr.write(data))
    ps.on('exit', (code, signal) => {
      log(`Process exited by code ${code}`)
    })
  },
  start: true,
  timeZone: 'Asia/Tokyo',
})

// ----------------------------------------------------------------------------

const express = require('express')
const app = express()

app.get('/', (req, res) => {
  res.send('OK')
})

app.get('/healthcheck', (req, res) => {
  res.send('OK')
})

const port = process.env.PORT || 3000
app.listen(port, () => {
  log(`Listen: http://localhost:${port}`)
})

// vim: se et ts=2 sw=2 sts=2 ft=javascript :
